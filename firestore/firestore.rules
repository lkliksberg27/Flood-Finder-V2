rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─── Helper functions ───────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      // Admin users have a custom claim set via Firebase Admin SDK
      // Set with: admin.auth().setCustomUserClaims(uid, { admin: true })
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // ─── devices collection (latest state per sensor) ───────────
    // Public: read-only access to device status for map view
    // Admin: full read/write for managing device config
    match /devices/{deviceId} {
      allow read: if true;                    // Public can see flood status
      allow create, update: if isAdmin();     // Only admin can configure devices
      allow delete: if isAdmin();

      // Cloud Functions bypass rules (uses Admin SDK), so the ingest
      // function can write here without any rule.
    }

    // ─── readings collection (raw time-series) ──────────────────
    // Admin only. No public access to raw sensor data.
    match /readings/{readingId} {
      allow read: if isAdmin();
      allow write: if false;                  // Only Cloud Functions (Admin SDK) write here
    }

    // ─── alerts collection (status change log) ──────────────────
    match /alerts/{alertId} {
      allow read: if isAdmin();
      allow update: if isAdmin();             // Admin can acknowledge alerts
      allow create, delete: if false;         // Only Cloud Functions write here
    }

    // ─── config collection ──────────────────────────────────────
    match /config/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // ─── Deny everything else ───────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
